<!DOCTYPE html>
<html>
  <head>
    <title>Admin Dashboard</title>
    <style>
      * {
        box-sizing: border-box;
        max-width: 100vw;
      }
      body {
        width: auto;
        height: auto;
        overflow-x: hidden;
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      h2 {
        text-align: center;
      }
      h3 {
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
      }
      th {
        background-color: #333;
        color: white;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 10px;
      }
      button:hover {
        background-color: darkred;
      }
    </style>
  </head>
  <body>
    <button onclick="logout()">Logout</button>
    <h2>Customer Orders</h2>

    <table>
      <thead>
        <tr>
          <th>Dish</th>
          <th>Quantity</th>
          <th>Total Price</th>
          <th>Ordered At</th>
          <th>Preparation Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="order-table-body"></tbody>
    </table>

    <button onclick="clearOrders()">Clear All Orders</button>
    <h3>Order History</h3>
    <table id="order-history">
      <thead>
        <tr>
          <th>Dish</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Ordered At</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="history-table-body"></tbody>
    </table>
    <button onclick="clearOrders1()">Clear Order History</button>

    <script>


      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const orderHistory =
        JSON.parse(localStorage.getItem("orderHistory")) || [];
      const tbody = document.getElementById("order-table-body");
      const historyBody = document.getElementById("history-table-body");
      function formatTime(seconds) {
        const mins = String(Math.floor(seconds / 60)).padStart(2, "0");
        const secs = String(seconds % 60).padStart(2, "0");
        return `${mins}:${secs}`;
      }
      function getAllOrderTimestamps() {
        const live = JSON.parse(localStorage.getItem("orders")) || [];
        const history = JSON.parse(localStorage.getItem("orderHistory")) || [];
        const all = [...live, ...history];
        const uniqueTimestamps = Array.from(
          new Set(all.map((o) => o.timestamp))
        ).sort();
        const orderIndexMap = {};
        uniqueTimestamps.forEach((ts, idx) => (orderIndexMap[ts] = idx + 1));
        return orderIndexMap;
      }
      function syncOrderHistoryToDB() {
        const orderHistory =
          JSON.parse(localStorage.getItem("orderHistory")) || [];
        if (orderHistory.length === 0) return;

         const cleanedHistory = orderHistory.map(order => ({
          ...order,
          timestamp: new Date(order.timestamp).toLocaleString('en-US')
        }));
        fetch("http://localhost:5000/store_order_history", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(orderHistory),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Synced to DB:", data);
          })
          .catch((error) => {
            console.error("DB Sync Error:", error);
          });
      }
      function renderOrderHistory() {
        const history = JSON.parse(localStorage.getItem("orderHistory")) || [];
        const historyBody = document.getElementById("history-table-body");
        historyBody.innerHTML = "";
        const grouped = {};
        history.forEach((order) => {
          if (!grouped[order.timestamp]) grouped[order.timestamp] = [];
          grouped[order.timestamp].push(order);
        });
        const orderMap = getAllOrderTimestamps();
        Object.keys(grouped)
          .sort()
          .forEach((ts) => {
            const idRow = document.createElement("tr");
            idRow.classList.add("order-id-row");
            idRow.innerHTML = `<td colspan="5">Order ID #${orderMap[ts]}</td>`;
            historyBody.appendChild(idRow);
            grouped[ts].forEach((order) => {
              const row = document.createElement("tr");
              row.innerHTML = `
            <td>${order.dish}</td>
            <td>${order.quantity}</td>
            <td>₹${order.price * order.quantity}</td>
            <td>${new Date(order.timestamp).toLocaleString()}</td>
            <td>Completed</td>
          `;
              historyBody.appendChild(row);
            });
          });
      }

      syncOrderHistoryToDB(); 


      function completeOrder(order) {
        let currentOrders = JSON.parse(localStorage.getItem("orders")) || [];
        let history = JSON.parse(localStorage.getItem("orderHistory")) || [];

        const index = currentOrders.findIndex(
          (o) =>
            o.dish === order.dish &&
            o.timestamp === order.timestamp &&
            o.startTime === order.startTime
        );

        if (index !== -1) {
          const finished = currentOrders.splice(index, 1)[0];
          history.push(finished);
          localStorage.setItem("orders", JSON.stringify(currentOrders));
          localStorage.setItem("orderHistory", JSON.stringify(history));
          fetch("http://localhost:5000/store_order_history", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify([finished]),
          })
            .then((res) => res.json())
            .then((data) => console.log("Order stored in DB:", data))
            .catch((err) => console.error("DB store failed:", err));
          renderOrderHistory();
          location.reload();
        }
      }
      function startTimer(seconds, displayEl, order, row) {
        let timeLeft = seconds;

        const timer = setInterval(() => {
          if (timeLeft <= 0) {
            clearInterval(timer);
            displayEl.textContent = "Ready!";
            completeOrder(order);
            row.remove();
            renderOrders();
          } else {
            displayEl.textContent = formatTime(timeLeft);
            timeLeft--;
          }
        }, 1000);
      }

      function renderOrders() {
        const tbody = document.getElementById("order-table-body");
        tbody.innerHTML = "";
        const orders = JSON.parse(localStorage.getItem("orders")) || [];
        const now = Date.now();

        if (orders.length === 0) {
          tbody.innerHTML = "<tr><td colspan='6'>No orders Running</td></tr>";
          return;
        }

        const orderMap = getAllOrderTimestamps();
        let renderedTimestamps = new Set();

        orders.forEach((order, index) => {
          const prepTimeInSec = order.prepTime * order.quantity;
          const start = order.startTime;
          const end = start + prepTimeInSec * 1000;
          const timeLeft = Math.max(Math.floor((end - now) / 1000), 0);
          const hasStarted = now >= start;
          const isCompleted = now >= end;

          const status = isCompleted
            ? "Ready!"
            : hasStarted
            ? `Prepared in ${formatTime(timeLeft)} mins`
            : "Waiting";

          if (!renderedTimestamps.has(order.timestamp)) {
            renderedTimestamps.add(order.timestamp);
            const idRow = document.createElement("tr");
            idRow.classList.add("order-id-row");
            idRow.innerHTML = `<td colspan="6">Order ID #${
              orderMap[order.timestamp]
            }</td>`;
            tbody.appendChild(idRow);
          }
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.dish}</td>
            <td>${order.quantity}</td>
            <td>₹${order.price}</td>
            <td>${new Date(order.timestamp).toLocaleString()}</td>
            <td>${formatTime(prepTimeInSec)}</td>
            <td>${status}</td>
          `;

          if (!isCompleted && hasStarted && index === 0) {
            row.classList.add("highlight");
          }

          if (isCompleted) {
            completeOrder(order);
          } else {
            tbody.appendChild(row);
          }
        });
      }

      renderOrders();
      renderOrderHistory();
      setInterval(renderOrders, 1000);

      function clearOrders() {
        if (confirm("Are you sure you want to delete all orders?")) {
          localStorage.removeItem("orders");
          location.reload();
        }
      }
      function clearOrders1() {
        if (confirm("Are you sure you want to delete orders History?")) {
          localStorage.removeItem("orderHistory");
          location.reload();
        }
      }
      function logout() {
        localStorage.removeItem("isAdminLoggedIn");
        window.location.href = "{{ url_for('adminlogin') }}";
      }
    </script>
  </body>
</html>
